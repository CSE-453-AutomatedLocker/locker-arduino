#include "AccessControl.h"
#include "KeyUtils.h"

static bool init_p = false;
static MFRC522 *rfid = NULL;

static int solenoid = -1;
static bool locked = true;
static long unlocked_time = -1;

void init_access_ctrl(int ss_pin, int rst_pin, int solenoid_pin)
{
  if (init_p) return;
  solenoid = solenoid_pin;
  locked = true;
  unlocked_time = -1;
  rfid = new MFRC522(ss_pin, rst_pin);

  init_p = true;
}

bool checkKey() {
  // Check if there is a new card being shown
  if(!rfid->PICC_IsNewCardPresent()) {
    return false;
  }

  // Read the card
  bool ok = this->rfid->PICC_ReadCardSerial();
  if(!ok) return false;

  // Get PICC type (should be MIFARE)
  Serial.print(F("PICC type: "));
  MFRC522::PICC_Type piccType = this->rfid->PICC_GetType(this->rfid->uid.sak);
  Serial.println(this->rfid->PICC_GetTypeName(piccType));

  // Check is the PICC of Classic MIFARE type
  if (piccType != MFRC522::PICC_TYPE_MIFARE_MINI &&
      piccType != MFRC522::PICC_TYPE_MIFARE_1K &&
      piccType != MFRC522::PICC_TYPE_MIFARE_4K) {
    Serial.println(F("Your tag is not of type MIFARE Classic."));
    return false;
  }

  // Return whether read key is present in EEPROM
  return containsKey(rfid->uid.uidByte);
}


bool AccessControl::checkKey() {
  // Check if there is a new card being shown
  if(!(this->rfid->PICC_IsNewCardPresent())) {
    return false;
  }

  // Read the card
  bool ok = this->rfid->PICC_ReadCardSerial();
  if(!ok) return false;

  // Get PICC type (should be MIFARE)
  Serial.print(F("PICC type: "));
  MFRC522::PICC_Type piccType = this->rfid->PICC_GetType(this->rfid->uid.sak);
  Serial.println(this->rfid->PICC_GetTypeName(piccType));

  // Check is the PICC of Classic MIFARE type
  if (piccType != MFRC522::PICC_TYPE_MIFARE_MINI &&
      piccType != MFRC522::PICC_TYPE_MIFARE_1K &&
      piccType != MFRC522::PICC_TYPE_MIFARE_4K) {
    Serial.println(F("Your tag is not of type MIFARE Classic."));
    return false;
  }

  // Return whether read key is present in EEPROM
  return containsKey(rfid->uid.uidByte);
}

void AccessControl::unlock() {
  if (!this->locked) return;
  this->locked = false;
  this->unlocked_time = millis();
  digitalWrite(this->solenoid, HIGH);
}

void AccessControl::lock() {
  if (this->locked) return;
  this->locked = true;
  this->unlocked_time = -1;
  digitalWrite(this->solenoid, LOW);
}

long AccessControl::unlocked_ms() {
  if (this->locked) return -1;
  return millis() - this->unlocked_time;
}
